Graphics.prototype.setFontKnx18 = function () {
    this.setFontCustom(atob("AAAAAAAAAAAAAAAAAAP8gAAAAAAMAAAAAMAAAAAAAAGAQJBgGGAAYABhgGCQIBgAAAAAAEAAIAAAAAB+AOBgQAQAAAAAAQAQOBgB+AAAAAAAAIABJAAqAAUAAqABJAAIAAAAAAAAIAAIAAIAB/AAIAAIAAIAAAAAAAAAIAAwAAAAAAAIAAIAAIAAIAAIAAIAAAAAAAAAwAAAAAAABwAGAAIABwAOAAAAAAAAD/AEAgIAQIQQIAQEAgD/AAAAAAACAAEAAP/wAAAAAACBwECQIEQIIQEQQDgQAAAAAACBAEAgIQQIQQEogDHAAAAAAAAHAAZABhAOBAAfwABAAAAAAAPhAIggIgQIgQIQgIPAAAAAAAB/ACQgEgQIgQIQgAPAAAAAAAIAAIAAIBwIOAJwAOAAAAAAAADHAEogIQQIQQIQQEogDHAAAAAAADgAEQAIIQIIQIIgETAD8AAAAAAAAxgAAAAAACAAEAAIAAIMwIQAEgADAAAAAAAAADwA+ADCAMCADCAA+AADwAAAAAAP/wIQQIQQIQQEogDHAAAAAAAD/AEAgIAQIAQEAgCBAAAAAAAP/wIAQIAQIAQEAgD/AAAAAAAP/wIQQIQQIQQIQQIAQAAAAAAP/wIQAIQAIQAIQAIAAAAAAAAD/AEAgIAQIAQIIQEIgAPgAAAAAAP/wAQAAQAAQAAQAAQAP/wAAAAAAIAQP/wIAQAAAAAAABAAAgAAQAAQAAgP/AAAAAAAP/wAQAAoABEACCAMBwAAAAAAP/wAAQAAQAAQAAQAAQAAAAAAP/wGAABgAAYABgAGAAP/wAAAAAAP/wGAABgAAYAAGAABgP/wAAAAAAD/AEAgIAQIAQIAQEAgD/AAAAAAAP/wIIAIIAIIAEQADgAAAAAAAD/AEAgIAQIBQEAgD/QAAAAAAP/wIIAIIAIMAETADgwAAAAAADBAEggIQQIQQEIgCHAAAAAAAIAAIAAP/wIAAIAAAAAAAAP/AAAgAAQAAQAAgP/AAAAAAAOAAB4AAHAAAwAHAB4AOAAAAAAAAPAAA8AADwA8APAAA8AADwA8APAAAAAAAAIAwGDABsAAQABsAGDAIAwAAAAAAIAAGAABgAAfwBgAGAAIAAAAAAAAIBwIGQIIQIQQJgQOAQAAAAAAADAAkgBIQBIQBIQA/gAAAAAAP/gAggBAQBAQAggAfAAAAAAAAfAAggBAQBAQBAQAggAAAAAAAfAAggBAQBAQAggP/gAAAAAAAfAAkgBEQBEQAkQAcgAAAAAABAAH/wJAAIAAAAAAAAAfAAgiBASBASBASAgkA/4AAAAAAP/wAgABAABAABAAAgAAfwAAAAAAF/wAAAAAAAAIAAEAAEE/4AAAAAAP/wAEAAEAAKAARAAggBAQAAAAAAP/AAAgAAQAAAAAAB/wAgABAAA/wBAAAgAAfwAAAAAAB/wAgABAABAAAgAAfwAAAAAAAfAAggBAQBAQAggAfAAAAAAAA/8AggBAQBAQBAQAggAfAAAAAAAAfAAggBAQBAQBAQAggA/8AAAAAAA/wAQAAgABAABAAAAAAAAARAAogBIQBEQBEQAigARAAAAAAABAAH/ABAgBAQAAAAAAB/AAAgAAQAAQAAgB/wAAAAAABwAAMAADAAAwADAAMABwAAAAAAAB+AABwAGAAYAAGAABwB+AAAAAAABgwARAAKAAEAAKAARABgwAAAAAABwEAMEADYAAgADAAMABwAAAAAAABAwBBQBCQBEQBIQBwQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"), 32,atob("BgMFAAAJAAMFBQgJBAgDBwkFCAgICAgICQkDAAAAAAkACQgICAgICQgFCAgICQkJCAgICAcICQsJCQgAAAAAAAAICAgICAYJCQMGCQUJCAgJCQcJBggJCQkJCA=="), 256 | 18);
    };
      Graphics.prototype.setFontQuick64 = function(scale) { this.setFontCustom(atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/wAAAAAD///gAAAAf///8AAAB/////AAAD/////gAAH/////4AAf/gAB/8AAf4AAAP+AA/gAAAD+AB/AAAAB/AB+AAAAA/gD8AAAAAfgD4AAAAAPgD4AAAAAPgD4AAAAAPwD4AAAAAPwD4AAAAAHwD4AAAAAPwD4AAAAAPgD4AAAAAPgD8AAAAAfgD8AAAAAfgB+AAAAA/AB/gAAAB/AA/wAAAH+AAf+AAA/8AAP/8AP/4AAH/////wAAB/////gAAAf///+AAAAH///wAAAAAf/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8AAAAAAAB8AAAAAAAD8AAAAAAAD8AAAAAAAH4AAAAAAAP4AAAAAAAPwAAAAAAAfgAAAAAAA/AAAAAAAA/AAAAAAAB///////AB///////gD///////gD///////gB///////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB4AAAAHAAD4AAAAPgAH4AAAAfgAP4AAAA/gAfgAAAB/gA/AAAAD/gA+AAAAH/gB8AAAAf/gB8AAAA//gD4AAAB/vgD4AAAD/PgD4AAAH+PgDwAAAP4PgDwAAAfwPgDwAAA/gPgD4AAB/APgD4AAD+APgD4AAP8APgD8AAf4APgB+AB/wAPgB/AD/gAPgA/4f+AAPgA///8AAPgAf//4AAPgAP//gAAPgAD/+AAAPgAAfwAAAPgAAAAAAAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB4AAAAAYAB4AAAAA8AB4AAAAA+AB4AAAAA/AB4AAAAA/AB4AAAAAfgB4ADgAAPgB4AHwAAPgB4APwAAHgB4AfwAAHwB4A/wAAHwB4D/gAAHwB4H/gAAHwB4P/gAAHgB4f3wAAHgB4/nwAAPgB5/HwAAPgB/+H4AAfAB/4H4AAfAB/wD8AA/AB/gD/AD+AB/AB/gP8AB+AA///4AB8AAf//wAB4AAP//gAAAAAD//AAAAAAA/4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAAeAAAAAAAA/AAAAAAAD/AAAAAAAH/AAAAAAAP/AAAAAAA//AAAAAAB/fAAAAAAD+fAAAAAAH8fAAAAAAf4fAAAAAA/gfAAAAAB/AfAAAAAH+AfAAAAAP4AfAAAAAfwAfAAAAA/gAfAAAAD+AAfAAAAH8AAfAAAAP4AAfAAAA/wAAfAAAB///////AD///////gD///////gD///////gB///////AAAAAAfAAAAAAAAfAAAAAAAAfAAAAAAAAfAAAAAAAAfAAAAAAAAeAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPgAA4AAAP/wAA8AAf//4AB+AB///4AA/AB///wAA/AB//HwAAfAB/APgAAPgB4APgAAPgB4APAAAPgB4AfAAAPgB4AfAAAHgB4AfAAAHgB4AfAAAPgB4AfAAAPgB4AfAAAPgB4AfAAAPgB4APgAAPgB4APgAAfAB4APwAA/AB4AHwAA+AB4AH8AD+AB4AD+AH8AB4AB/5/4AB4AB///wAB4AA///gAB4AAP//AAAwAAD/8AAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH/wAAAAAB//+AAAAAP///gAAAA////wAAAD////4AAAH//wP8AAAf+/AD+AAA/58AA/AAB/h4AAfAAD/D4AAPgAH8DwAAPgAP4HwAAPgAfwHgAAHgA/gHgAAHwA/APgAAHwB+APgAAHwB+APgAAHwD8AHwAAPgD4AHwAAPgH4AH4AAPgHwAD4AAfADwAD8AA/ADgAB/AD+AAAAB/wP+AAAAA///8AAAAAf//4AAAAAH//gAAAAAB//AAAAAAAf4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB4AAAAAAAB4AAAAAAAB4AAAAAAAB4AAAAAAAB4AAAAAAAB4AAAAADAB4AAAAAfgB4AAAAB/gB4AAAAH/gB4AAAAf/gB4AAAD/+AB4AAAP/4AB4AAA//gAB4AAD/8AAB4AAf/wAAB4AB//AAAB4AH/8AAAB4A//gAAAB4D/+AAAAB4P/4AAAAB4//AAAAAB//8AAAAAB//wAAAAAB//AAAAAAB/4AAAAAAB/gAAAAAAB+AAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH8AAAAfwAf/AAAB/8A//wAAH/+D//4AAP//H//8AAf//n8H+AA/wf/wB+AA/AH/gA/AB+AD/AAfAB8AB+AAPgB8AA+AAPgD4AA+AAPgD4AA8AAPgD4AA8AAHgD4AA8AAHgD4AA8AAPgD4AA+AAPgB8AA+AAPgB8AB+AAPgB+AD/AAfAA/AH/gA/AA/wf/wB+AAf//n4H+AAP//D//8AAH/+D//4AAB/8B//wAAAfwAf/gAAAAAAH+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8AAAAAAB//gAAAAAD//4AAAAAH//8AAAAAf//+AAAAAf4H/AAAAA/gA/gADgB+AAfgAHgB8AAPwAHwD8AAHwAPwD4AAHwAPgD4AAHwAfgDwAAD4A/ADwAAD4A/AHwAAD4B+ADwAADwD+ADwAADwH8AD4AAHwP4AD4AAHwfwAD8AAPh/gAB8AAPD/AAB+AAfP+AAA/gB+/8AAAf4H//wAAAP////gAAAH///+AAAAD///wAAAAA///AAAAAAH/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB4AAAeAAAD+AAA/gAAD+AAA/gAAD+AAA/gAAD+AAA/gAAB8AAAfAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="), 48, atob("Kh4lISYjIyEiJBA="), 54+256);
         return this;
      };
    require("Font5x9Numeric7Seg").add(Graphics);
    
    Graphics.prototype.rotatePoly = (pArr, angle, xoff, yoff) => {
      let newArr = [];
      let a = angle;// * pRad;
      for(let i=0; i<pArr.length ; i+= 2) {
        newArr[i] = Math.round(xoff + Math.cos(a)*pArr[i] + Math.sin(a)*pArr[i+1]);
        newArr[i+1] =  Math.round(yoff + Math.sin(a)*pArr[i] - Math.cos(a)*pArr[i+1]);
      }
      return newArr;
    };
    
    function init() {
      var _C = {
        WHITE: "#FFFFFF",
        YHT: g.getHeight(),
        XWID: g.getWidth()-22,
        XMID: g.getWidth() / 2 - 11,
        YMID: g.getHeight() / 2,
        FG: "#000000", 
        BG: "#FFFFFF",
        MSGBG: "#FFFFFF",
        sidebar: 22,
      };
      
      g.setBgColor(_C.BG).setColor(_C.FG);
      g.clear();
    
      let widths = E.toString([42,30, 37,33,38,35,35,33,34,36,16]);
    
      let lastDate = '';
      
      let start = () => {
        //let y = 80;
        g.setBgColor(_C.BG).setColor(_C.FG);
        //g.fillCircle(78,y,4).fillCircle(78,y+32,4);
        //g.fillPoly([0,0, 4,0, 0,4 ], true);
      };
    
    
      function drawDate(dt) {
        //let dtstr = dt.toString().substring(0,16);
        let m = dt.getMonth()+1;
        let d = dt.getDate();
        if(lastDate != d) {
          lastDate = d;
          let digs = [Math.floor(m / 10), m % 10, 11, Math.floor(d / 10), d % 10]; //11 = '-'
          let x = 32;
          //g.drawLine(116,59,124,39).drawLine(117,59,125,39);
          for(let d = 0; d < digs.length; d++) {
            if(!d && !digs[d]) continue;
            drawDigit(digs[d], [x,x+22,x+40,x+58,x+80][d], 24, 0.33, 0.33);
          }
        }
      }
    
      function drawBattery(b) {
        x=105;
        g.clearRect(x,8,x+29,22);
        //g.setColor(1,1,1);
        if(b > 35) g.fillRect(x+1,9,x+8,20);
        if(b > 55) g.fillRect(x+10,9,x+17,20);
        if(b > 75) g.fillRect(x+19,9,x+26,20);
      }
    
    
      let drawClock = (t) => {
        g.setFontQuick64().setFontAlign(0,0);
        g.clearRect(0, _C.YMID-g.getFontHeight()/2, _C.XWID-1, _C.YMID+g.getFontHeight()/2);
        g.drawString(`${t.hr24}:${('0'+t.min).slice(-2)}`, _C.XMID, _C.YMID);
        sidebar(t);
      };
      
      let drawClockAna = (t) => {
        let size=72;
        let cx=size, cy=size;
        let arr = [0,0-size, 0,size];
        let hrhd = [-2,-8, 0,size-28, 2,-8];
        let mnhd = [-1,-8, 0,size-8, 1,-8];
    
        g.clearRect(cx-size,cy-size,cx+size,cy+size);
        ToRad = Math.PI/180;
        for(let a=0; a < 180; a+= 30) {
          let pts = g.rotatePoly(arr, a*ToRad, cx, cy);
          g.drawLine(pts[0],pts[1],pts[2],pts[3]);
        }
        g.setColor(-1).fillCircle(cx,cy, size-8).setColor(0);
        for(let a=0; a < 180; a+= 90) {
          let pts = g.rotatePoly(arr, a*ToRad, cx, cy);
          g.drawLine(pts[0],pts[1],pts[2],pts[3]);
        }
        g.setColor(-1).fillCircle(cx,cy, size-12).setColor(0);
    
        d = new Date();
        d = {hr: d.getHours(), min: d.getMinutes() };
        let a = (d.hr * 60 + d.min) * Math.PI / 360;
        let pts = g.rotatePoly(hrhd, a, cx, cy);
        g.drawPoly(pts,true);
    
        a = d.min / 30 * Math.PI;
        pts = g.rotatePoly(mnhd, a, cx, cy);
        g.drawPoly(pts,true);
        g.setColor(-1).fillCircle(cx,cy,3);
        g.setColor(0).drawCircle(cx,cy,3);
        /*
        g.flip();
        if(d.min == 58) setTimeout(()=>{g.init();}, 5000); // full refresh on hour
        if(d.min == 0) setTimeout(()=>{g.setPartial();}, 5000); // back to partial
        */
        sidebar(t);
    };
    
      
      let drawData = (d) => {
        g.setFont("Knx18",1).setFontAlign(0,0).setBgColor(_C.BG).setColor(_C.FG);
        //drawBattery(E.getBattery());
        //drawDate(new Date());
        /*
        let strs = d.niceDate.toUpperCase().split(' ');
        let y=8;
        g.drawBold(` ${strs[0]} `, _C.XWID-8,144-g.getFontHeight(), true);
        g.drawBold(` ${strs[1]} `, _C.XWID-8, y, true);
        g.drawBold(` ${strs[2]} `, _C.XWID-8, y+g.getFontHeight(), true);
        */
        let str = d.niceDate.toUpperCase();
        let y=38;
        g.drawBold(` ${str} `, _C.XMID, y, true);
    
      };
    
      function sidebar(d) {
        g.setFont("5x9Numeric7Seg",2);
    
        g.setFontAlign(0,-1);
        g.setRotation(1,1).setColor(_C.FG);
        g.fillRect(0,0,199,_C.sidebar).setColor(_C.BG);
        g.drawBold(`${d.hr24}:${('0'+d.min).slice(-2)}`,100, 2);
        g.setRotation(2,1).setColor(_C.FG);
      }
      
      let showMsg = (msgobj) => {
        g.setFont("Knx18",1).setFontAlign(0,-1);
        g.clearRect(0,144,_C.XWID-1,_C.YHT-1);
        g.drawBold( g.wrapString(msgobj.text, _C.XWID).join("\n"), _C.XMID, 144);
        //g.drawString( msgobj.text.split('|').join("\n"), _C.XMID+1, 160);
        lastDate = '';
      };
    
    
      /*
      let stop = () => {
        wOS.removeListener("tick", secs);
      };
      */
    
      return {
        start: start,
        drawClock: drawClock,
        drawData: drawData,
        showMsg: showMsg,
        //stop: stop
      };
    }
    exports = init();
    g.drawBold = (str, x, y, bkgd) => {
      g.drawString(str, x, y, bkgd);
      g.drawString(str, x+1, y, false);
    };
    /*
    if(process.env.BOARD != "EMSCRIPTEN") {
      wOS.wake();
    } else {
      wOS = { BAT: D0 };
    }
    //E.getBattery = () => {return 100;};
    */
    //*
    exports.start();
    let dt = { hr: 12, min: 35, niceDate: "Sun Jul 12", hr24:14, isPM: true };
    //g.setColor("#808080").fillRect(0,0,200,200);
    exports.drawClock(dt);
    exports.drawData(dt);
    exports.showMsg({title:"Title", text:"This would be message 1 | That's it"});
    setTimeout(g.flip, 2000);
    //*/